<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notify Vehicle Owner</title>
    <link rel="stylesheet" href="css/app.css">
</head>
<body>

    <div class="card">
        <h2 id="title">Notify Vehicle Owner</h2>
        <div class="subtitle" id="subtitle">Select the issue related to this vehicle</div>

        <div class="lang">
            <button id="enBtn" class="active" onclick="setLang('en')">English</button>
            <button id="hiBtn" onclick="setLang('hi')">हिंदी</button>
        </div>

        <div class="category-grid" id="categories"></div>
        <div id="issues"></div>

        <button class="main" id="notifyBtn" onclick="send()">Notify Owner</button>

        <div id="waiting" class="status waiting">
            ⏳ Waiting for owner response…
        </div>

        <div id="replyBox" class="status success"></div>
    </div>

    <script>
        const stickerId = new URLSearchParams(window.location.search).get("id");
        let lang = "en";
        let openCategory = null;
        let selectedIssue = "";
        let pollingStarted = false;

        const data = {
            en: {
                title: "Notify Vehicle Owner",
                subtitle: "Select the issue related to this vehicle",
                notify: "Notify Owner",
                waiting: "⏳ Waiting for owner response…",
                replyPrefix: "🚗 Owner response:",
                categories: {
                    Parking: { icon: "🚗", name: "Parking", issues: ["Blocking my car", "No-parking zone", "Double parked", "Wrong side parking"] },
                    Blocking: { icon: "🚧", name: "Blocking", issues: ["Blocking gate", "Blocking exit", "Blocking fire access"] },
                    Emergency: { icon: "🚨", name: "Emergency", issues: ["Accident nearby", "Vehicle damaged", "Alarm ringing"] },
                    Safety: { icon: "🔐", name: "Safety", issues: ["Lights left ON", "Door / boot open", "Child or pet locked inside"] }
                }
            },
            hi: {
                title: "वाहन मालिक को सूचित करें",
                subtitle: "कृपया समस्या चुनें",
                notify: "मालिक को सूचित करें",
                waiting: "⏳ मालिक के जवाब की प्रतीक्षा हो रही है…",
                replyPrefix: "🚗 मालिक का जवाब:",
                categories: {
                    Parking: { icon: "🚗", name: "पार्किंग", issues: ["मेरी कार रोक रहा है", "नो पार्किंग", "डबल पार्किंग", "गलत साइड पार्किंग"] },
                    Blocking: { icon: "🚧", name: "रास्ता अवरुद्ध", issues: ["गेट रोक रहा है", "निकास रोक रहा है", "आपात रास्ता बंद"] },
                    Emergency: { icon: "🚨", name: "आपात स्थिति", issues: ["दुर्घटना", "वाहन क्षतिग्रस्त", "अलार्म बज रहा है"] },
                    Safety: { icon: "🔐", name: "सुरक्षा", issues: ["लाइट चालू है", "दरवाज़ा खुला", "बच्चा अंदर"] }
                }
            }
        };

        function render() {
            document.getElementById("title").innerText = data[lang].title;
            document.getElementById("subtitle").innerText = data[lang].subtitle;
            document.getElementById("notifyBtn").innerText = data[lang].notify;
            document.getElementById("waiting").innerText = data[lang].waiting;

            const catBox = document.getElementById("categories");
            const issuesBox = document.getElementById("issues");
            catBox.innerHTML = "";
            issuesBox.innerHTML = "";

            Object.keys(data[lang].categories).forEach(key => {
                const c = data[lang].categories[key];
                const div = document.createElement("div");
                div.className = "category-card" + (openCategory === key ? " active" : "");
                div.innerHTML = `<div class="icon">${c.icon}</div><div class="cat-title">${c.name}</div>`;
                div.onclick = () => toggleCategory(key);
                catBox.appendChild(div);
            });

            if (openCategory) {
                data[lang].categories[openCategory].issues.forEach(issue => {
                    const i = document.createElement("div");
                    i.className = "issue";
                    i.innerText = issue;
                    i.onclick = () => {
                        document.querySelectorAll(".issue").forEach(x => x.classList.remove("active"));
                        i.classList.add("active");
                        selectedIssue = issue;
                    };
                    issuesBox.appendChild(i);
                });
            }
        }

        function toggleCategory(key) {
            openCategory = openCategory === key ? null : key;
            selectedIssue = "";
            render();
        }

        function setLang(l) {
            lang = l;
            document.getElementById("enBtn").classList.toggle("active", l === "en");
            document.getElementById("hiBtn").classList.toggle("active", l === "hi");
            openCategory = null;
            selectedIssue = "";
            render();
        }

        function send() {
            if (!selectedIssue) return alert("Please select an issue");

            document.getElementById("notifyBtn").disabled = true;
            document.getElementById("waiting").style.display = "block";

            fetch("/notify", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    stickerId,
                    category: openCategory,
                    reason: selectedIssue,
                    lang
                })
            }).then(() => {
                if (!pollingStarted) {
                    pollingStarted = true;
                    startPolling();
                }
            });
        }

        function startPolling() {
            setInterval(() => {
                fetch(`/check-reply?id=${stickerId}`)
                    .then(r => r.json())
                    .then(dataReply => {
                        if (dataReply.reply) {
                            document.getElementById("waiting").style.display = "none";
                            const box = document.getElementById("replyBox");
                            box.innerText = `${data[lang].replyPrefix} ${dataReply.reply}`;
                            box.style.display = "block";
                        }
                    });
            }, 2000);
        }

        render();
    </script>

</body>
</html>
